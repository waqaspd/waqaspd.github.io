<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/10.0.2/jsoneditor.min.css">
  </head>
  <body>
    <div class="jumbotron">
      <h1 class="display-4">ğŸ”¥ PagerDuty Event Alert Trigger ğŸ”¥</h1>
      <p class="lead">Trigger a real-time Pagerduty Event using the events API V2</p>
      <button name="button" id="mainbutton" class="btn btn-outline-danger btn.lg" type="button">Send Event â˜ï¸</button>
      <br />
      <br />
      <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text" id="inputGroup-sizing-default">Service/Ochestration Integration Key</span>
        </div>
        <input type="text" class="form-control" name="routingkey" id="routingkey" placeholder="Enter your routing key">
      </div>

      <div class="form-group">
        <label for="exampleFormControlTextarea1">A Sample JSON Payload below. Feel free to modify. Routing key will be replaced with the one entered in the field so there is no need to change that in the payload.</label>
        <div id="jsoneditor" style="height: 500px;"></div>
      </div>
      For more information <a href="https://developer.pagerduty.com/docs/ZG9jOjExMDI5NTgw-events-api-v2-overview" target="_blank">PagerDuty Events</a> - Events API payloads are limited to 512 KB
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/10.0.2/jsoneditor.min.js"></script>

    <script>
      var container = document.getElementById("jsoneditor");
      var options = {
        mode: "code",
        onChange: function() {
          var json = editor.get();
        }
      };

      var editor = new JSONEditor(container, options);

      var json = {
        "payload": {
          "summary": "My Server is on Fire!",
          "timestamp": "2024-04-15T08:42:58.315+0000",
          "severity": "critical",
          "source": "prod-web-srv.example.com",
          "component": "mysql",
          "group": "prod-web-server",
          "class": "disk",
          "custom_details": {
            "free space": "1%",
            "ping time": "1500ms",
            "load avg": 0.75
          }
        },
        "routing_key": "routing-key",
        "dedup_key": "samplededupkey2024",
        "event_action": "trigger",
        "client": "Sample Monitoring Service",
        "client_url": "https://monitoring.service.com",
        "links": [
          {
            "href": "http://example.pagerduty.com",
            "text": "An example link."
          }
        ],
        "images": [
          {
            "src": "https://chart.googleapis.com/chart?chs=600x400&chd=t:6,2,9,5,2,5,7,4,8,2,1&cht=lc&chds=a&chxt=y&chm=D,0033FF,0,0,5,1",
            "href": "https://google.com",
            "alt": "An example link with an image"
          }
        ]
      };

      editor.set(json);

      var button = document.querySelector('button');
      button.onclick = function() {
        eventfire()
      }

      function eventfire() {
        const doctext = document.getElementById('mainbutton')
        const rkey = document.getElementsByName('routingkey')[0].value.trim();

        if (rkey === "") {
          alert("Routing key cannot be empty. Please enter a valid routing key.");
          return; 
        }
        var json = editor.get();

        json.routing_key = rkey;

        var payload = JSON.stringify(json);
        var xhr = new XMLHttpRequest();
        var url = "https://events.pagerduty.com/v2/enqueue";

        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              // Successful response
              if (xhr.status === 202) {
                doctext.innerHTML = "ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ Event Sent ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥";
              } else {
                console.error("Error: Request failed with status " + xhr.status);
                console.error("Response Text: " + xhr.responseText);
                // Display a user-friendly error message
                alert("Failed to send the event. " + xhr.responseText);
              }
            } else {
              // Handle other status codes (e.g., 404, 500)
              console.error("Error: Request failed with status " + xhr.status);
              console.error("Response Text: " + xhr.responseText);
              // Display a user-friendly error message
             alert("Failed to send the event. " + xhr.responseText);
           }

            try {
              const responseJson = JSON.parse(xhr.responseText);
              editor.set(responseJson);
            } catch (error) {
              console.error("Error parsing response JSON: " + error);
            }
          }
        };

        console.log(payload);
        xhr.send(payload);
      }
    </script>
  </body>
</html>
